<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru">
<head>
    <link rel="stylesheet" href="/www/css/smoothness/jquery-ui-1.8.14.custom.css">
    <link rel="stylesheet" href="/www/css/ui.jqgrid.css">
    <link rel="stylesheet" href="/www/css/enodeman.css">
    <script type="text/javascript" src="/www/js/jquery.js"></script>
    <script type="text/javascript" src="/www/js/jquery-ui-1.8.14.custom.min.js"></script>
    <script type="text/javascript" src="/www/js/grid.locale-en.js"></script>
    <script type="text/javascript" src="/www/js/grid.locale-en.js"></script>
    <script type="text/javascript" src="/www/js/jquery.jqGrid.min.js"></script>
    <script type="text/javascript" src="/www/js/enodeman_grid.js"></script>
    <script type="text/javascript" src="/www/js/jit.js"></script>
    <script type="text/javascript" src="/www/js/enodeman_tree.js"></script>
    <script type="text/javascript" src="/www/js/raphaeljs/raphael-min.js"></script>
    <script type="text/javascript" src="/www/js/raphaeljs/g.raphael-min.js"></script>
    <script type="text/javascript" src="/www/js/raphaeljs/g.line-min.js"></script>
    <script type="text/javascript" src="/www/js/enodeman_graph.js"></script>
</head>
<body>
   <div id="tabs">
	<ul>
		<li><a href="#tabs-1">Grid</a></li>
		<li><a href="#tabs-2">Tree</a></li>
	</ul>
	<div id="tabs-1">
		<table id="nodes-list"></table>
    		<!--div id="nodes-pager"></div-->
    		<table id="processes-list"></table>
   	</div>
	<div id="tabs-2">
    		<div id="tree"></div>
	</div>
   </div>
    <!--div id="processes-pager"></div-->
    <div id="graphs"></div>
    <script type="text/javascript">
        (function() {
	    var tree = new ENMTree({
		targetId: "tree",
		dataURL: "/nodes/processes_tree",
		duration: 800,
		levelDistance: 50,
		node: {
			height: 20,
			width: 60,
			type: "rectangle",
			color: "#aaa"
		},
		edge: {
			type: "bezier"
		}
	   });
	    $("#tabs").tabs({
		show: function(e, ui) {
			if (ui.panel.id == "tabs-2") {
				tree.show(tree.data);
			}
		}
	    });
            new ENMGrid({
                target: $("#nodes-list"),
                //pager: $("#nodes-pager"),
                caption: "Nodes",
                columnsSpecUrl: "/node_metrics",
                dataUrl: "/nodes"
            });
            new ENMGrid({
                target: $("#processes-list"),
                //pager: $("#processes-pager"),
                caption: "Processes",
                columnsSpecUrl: "/proc_metrics",
                dataUrl: "/enodeman@127.0.0.1/processes"
            });

            function ENMStats(node) {
                $.get("/" + node + "/stats", {}, function(stats) {
                    var graphsEl = $("#graphs");
                    $.each(stats, function(i, stat) {
                        var xs = [];
                        var ys = [];
                        $.each(stat.data, function(j, part) {
                            xs[j] = [];
                            for (k = 0; k < part.stats.length; k++) {
                                xs[j].push(part.start_time + k * part.interval);
                            }
                            ys[j] = [];
                            for (k = 0 ; k < part.stats.length; k++) {
                                var v = part.stats[k];
                                if (v > 50000) v = v.toExponential(3);
                                ys[j].push(v);
                            }
                        });
                        var id = "metric_" + stat.metric;
                        graphsEl.append('<div id="' + id + '" class="enm-graph"></div>');
                        var graph = new ENMGraph({
                            targetId: id,
                            width: 900,
                            height: 250,
                            caption: node + ": " + stat.metric,
                            xTranslator: function(x) {
                                return new Date(x).toTimeString();
                            }
                        });
                        graph.add(
                            stat.metric,
                            xs,
                            ys
                        );
                        graph.draw();
                    });
                }, "jsonp");
            };
            ENMStats("enodeman@127.0.0.1");
        })();
    </script>
</body>
</html>
